<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>CavesOfOoo â€” Stringâ€‘State Engine (mobileâ€‘friendly)</title>
<link rel="stylesheet" href="styles/main.css" />
</head>
<body>
<div class="wrap">
  <div class="layout-main">
    <canvas id="view" width="960" height="540"></canvas>
    <div id="heartbeat" style="position:relative;margin-top:6px;font:12px/1.2 ui-monospace;color:#9ee8ff;opacity:.85">engine: startingâ€¦</div>

    <div class="panel controls-panel">
      <h3>Stringâ€‘State Engine â€” mobile controls</h3>

      <div class="controls-body">
        <div class="controls-buttons">
          <div class="toolbar">
            <div class="zoom-controls" role="group" aria-label="Zoom controls">
              <button class="btn zoom-btn" id="zoomIn" type="button">+</button>
              <button class="btn zoom-btn" id="zoomOut" type="button">âˆ’</button>
            </div>
            <button class="btn" id="toggleTelemetry" type="button">ğŸ“Š Telemetry</button>
            <button class="btn" id="togglePause" type="button">â¸ï¸ Pause</button>
            <button class="btn" id="stepOnce" type="button">â­ï¸ Step</button>
            <button class="btn" id="fastStep" type="button">â© Step Ã—10</button>
            <button class="btn" id="toggleRecorder" type="button">ğŸ“¼ Recorder Off</button>
            <button class="btn" id="seedWarm" type="button">ğŸ”¥ Warm Grid</button>
            <button class="btn" id="scenarioDiagToggle" type="button">ğŸ©º Scenario Log</button>
            <label class="speed-label" for="simSpeed">Speed Ã—
              <input class="slider speed-slider" id="simSpeed" type="range" min="1" max="10" step="1" value="1">
              <span class="kbd" id="simSpeedVal">1</span>
            </label>
          </div>

          <div class="scenario-loader" id="scenarioLoader">
            <label class="scenario-label" for="scenarioSelect">Scenario</label>
            <div class="scenario-row">
              <select class="scenario-select" id="scenarioSelect">
                <option value="" data-placeholder="true">(Select scenario)</option>
              </select>
              <button class="btn" id="scenarioRefresh" type="button" title="Refresh scenario list">â†»</button>
              <button class="btn" id="scenarioLoad" type="button">Load</button>
            </div>
            <div class="small" id="scenarioStatusText" style="min-height:1.2em"></div>
          </div>

          <!-- Brush palette (tap to select) -->
          <div class="grid" id="brushGrid" aria-label="Brush palette">
            <button class="btn" data-brush="fire">ğŸ”¥ Fire</button>
            <button class="btn" data-brush="vent">ğŸªŸ Oâ‚‚ Vent</button>
            <button class="btn" data-brush="water">ğŸ’§ Water</button>
            <button class="btn" data-brush="ice">ğŸ§Š Ice</button>
            <button class="btn" data-brush="cryofoam">ğŸ§¯ Cryofoam</button>
            <button class="btn" data-brush="acid">ğŸ§ª Acid</button>
            <button class="btn" data-brush="base">ğŸ§´ Base</button>
            <button class="btn" data-brush="clf3">â˜£ï¸ ClFâ‚ƒ Canister</button>
            <button class="btn" data-brush="mycelium">ğŸ„ Mycelium</button>
            <button class="btn" data-brush="pheromone-help">ğŸ†˜ Help Field</button>
            <button class="btn" data-brush="pheromone-panic">âš ï¸ Panic Field</button>
            <button class="btn" data-brush="pheromone-route">ğŸ§­ Route Field</button>
            <button class="btn" data-brush="pheromone-safe">ğŸ›¡ï¸ Safe Field</button>
            <button class="btn" data-brush="pheromone-escape">ğŸšª Escape Field</button>
            <button class="btn" data-brush="door">ğŸšª Door</button>
            <button class="btn" data-brush="toggle-control">âš”ï¸ Toggle Frontline</button>
            <button class="btn" id="toggleFrontier">ğŸŒ Toggle Frontier Field</button>
            <button class="btn" data-brush="toggle-reinforce">ğŸ° Toggle Reinforce</button>
            <button class="btn" data-brush="toggle-reinforce-log">ğŸ“£ Reinforce Logs</button>
            <button class="btn" data-brush="spawn-calm">ğŸ™‚ Place Calm Agent</button>
            <button class="btn" data-brush="spawn-panic">ğŸ˜± Place Panicking Agent</button>
            <button class="btn" data-brush="wall">ğŸ§± Wall</button>
            <button class="btn" data-brush="eraser">ğŸ§¹ Eraser</button>
            <button class="btn" id="toggleDraw">âœï¸ Draw</button>
          </div>

          <div class="factory-panel" id="factoryPanel">
            <div class="factory-header">
              <h4>Factory Builder</h4>
              <div class="factory-orientation" aria-live="polite">
                <button class="btn factory-rotate" id="factoryRotateLeft" type="button">âŸ²</button>
                <span class="factory-orientation-label" id="factoryOrientation">East</span>
                <button class="btn factory-rotate" id="factoryRotateRight" type="button">âŸ³</button>
              </div>
            </div>
            <div class="grid factory-grid" id="factoryBrushGrid" aria-label="Factory builder brushes">
              <button class="btn" data-brush="factory-node">ğŸª¨ Ore Node</button>
              <button class="btn" data-brush="factory-miner">â›ï¸ Miner</button>
              <button class="btn" data-brush="factory-belt">â¡ï¸ Conveyor</button>
              <button class="btn" data-brush="factory-smelter">ğŸ”¥ Smelter</button>
              <button class="btn" data-brush="factory-constructor">ğŸ­ Constructor</button>
              <button class="btn" data-brush="factory-storage">ğŸ“¦ Storage</button>
            </div>
            <div class="small factory-status" id="factoryStatus">Ore 0 â€¢ Ingots 0 â€¢ Plates 0 â€¢ Stored Plates 0</div>
            <div class="small factory-status" id="factoryJobs">Jobs: 0</div>
            <div class="small factory-status" id="factoryWorkers">Workers: â€”</div>
            <div class="small factory-hint">Use âŸ²/âŸ³ or [ / ] keys to rotate placement direction. Hold Alt while erasing to remove ore nodes.</div>
          </div>

          <!-- Actions -->
          <div class="grid actions-grid">
            <button class="btn" id="spawnCalmA">ğŸ™‚ NPC Calm A</button>
            <button class="btn" id="spawnCalmB">ğŸ™‚ NPC Calm B</button>
            <button class="btn" id="spawnCalmC">ğŸ™‚ NPC Calm C</button>
            <button class="btn" id="spawnPanicA">ğŸ˜± NPC Panic A</button>
            <button class="btn" id="spawnPanicB">ğŸ˜± NPC Panic B</button>
            <button class="btn" id="spawnMedic">ğŸ’Š Medic</button>
            <button class="btn" id="spawnWorker">ğŸ› ï¸ Spawn Worker</button>
            <button class="btn" id="spark">âš¡ Random Fire</button>
            <button class="btn" id="clear">ğŸ§¼ Clear</button>
          </div>
        </div>

        <div class="controls-sliders">
          <label class="slider-row">Heat diffusion
            <input class="slider" id="dHeat" type="range" min="0" max="0.6" step="0.01" value="0.18">
            <span class="kbd" id="dHeatVal">0.18</span>
          </label>
          <label class="slider-row">Oâ‚‚ diffusion
            <input class="slider" id="dO2" type="range" min="0" max="0.4" step="0.01" value="0.30">
            <span class="kbd" id="dO2Val">0.10</span>
          </label>
          <label class="slider-row">Oâ‚‚ baseline
            <input class="slider" id="o2Base" type="range" min="0" max="0.30" step="0.005" value="0.21">
            <span class="kbd" id="o2BaseVal">0.21</span>
          </label>
          <label class="slider-row">Oâ‚‚ cutoff
            <input class="slider" id="o2Cut" type="range" min="0" max="0.21" step="0.005" value="0.16">
            <span class="kbd" id="o2CutVal">0.16</span>
          </label>
          <label class="slider-row">Canvas size
            <select id="canvasSize" class="select-input">
              <option value="auto">Auto fit</option>
              <option value="960x540">960 Ã— 540</option>
              <option value="1280x720">1280 Ã— 720</option>
              <option value="1440x810">1440 Ã— 810</option>
              <option value="1600x900">1600 Ã— 900</option>
            </select>
          </label>
        </div>
      </div>

      <div class="legend">
        <span class="chip"><i class="dot" style="background:#ff6a00"></i> Fire</span>
        <span class="chip"><i class="dot" style="background:#7bdcff"></i> Oâ‚‚ field</span>
        <span class="chip"><i class="dot" style="background:#ff7a7a"></i> Heat</span>
      <span class="chip"><i class="dot" style="background:#00ffb3"></i> Vent</span>
      <span class="chip"><i class="dot" style="background:#8891a7"></i> Wall</span>
      <span class="chip"><i class="dot" style="background:#b9e8ff"></i> Ice</span>
      <span class="chip"><i class="dot" style="background:#d7f3ff;border:1px solid #6fbde6"></i> Cryofoam</span>
      <span class="chip"><i class="dot" style="background:#7eed75"></i> ClFâ‚ƒ Canister</span>
      <span class="chip"><i class="dot" style="background:#ffd166"></i> NPC calm</span>
      <span class="chip"><i class="dot" style="background:#ef476f"></i> NPC panic</span>
      </div>

      <div class="small" style="margin-top:6px">Tip: tap a brush, toggle <b>Draw</b>, then drag your finger on the canvas. Use ğŸ§¹ Eraser to remove. Everything works with touch only; no rightâ€‘click or modifier keys needed.</div>
    </div>
  </div>
  <aside class="panel metrics-panel" aria-label="Live metrics">
    <button class="accordion" id="metricsToggle" type="button" aria-expanded="false">Live Metrics <span class="accordion-icon">â–¸</span></button>
    <div class="metrics-summary" id="metricsSummary" hidden>
      <div class="row"><span>Avg Oâ‚‚ (fraction)</span><span class="kbd" id="mO2">â€”</span></div>
      <div class="row small"><span>Î” Oâ‚‚ per step (~0.1s)</span><span class="kbd" id="mO2d">â€”</span></div>
      <div class="row"><span>Total Fire Intensity</span><span class="kbd" id="mFire">â€”</span></div>
      <div class="row small"><span>Î” Fire per step (~0.1s)</span><span class="kbd" id="mFired">â€”</span></div>
      <div class="row" style="margin-top:6px"><span>Avg Amplitude</span><span class="kbd" id="mAmpAvg">â€”</span></div>
      <div class="row"><span>Avg Tension</span><span class="kbd" id="mTensionAvg">â€”</span></div>
      <div class="row"><span>Avg Heat</span><span class="kbd" id="mHeatAvg">â€”</span></div>
      <div class="row small"><span>Pheromone Totals</span><span class="kbd" id="mFieldTotals">â€”</span></div>
      <div class="row small"><span>Agents &gt; Hot Threshold</span><span class="kbd" id="mHotAgents">â€”</span></div>
      <div class="row small"><span>Overwhelmed Agents</span><span class="kbd" id="mOverwhelmed">â€”</span></div>
      <div class="row small"><span>Stuck Agents</span><span class="kbd" id="mStuckAgents">â€”</span></div>
    </div>
      <div class="small" style="width:100%;margin-top:4px">Modes</div>
      <div class="small" id="mModeCounts" style="display:flex;flex-wrap:wrap;gap:4px"></div>

    <div class="small" style="margin-top:6px;display:flex;align-items:center;gap:4px">Amplitude Histogram <span class="hint" data-hint="X-axis: amplitude (0 = calm, 1 = max). Y-axis: number of tiles falling into each bin.">â„¹ï¸</span></div>
    <div id="histAmp" style="display:flex;align-items:flex-end;height:40px;gap:2px;width:100%;background:#111a33;border-radius:6px;padding:2px"></div>
    <div class="small" style="display:flex;justify-content:space-between;width:100%;font-size:10px;color:#9eaad1"><span>0</span><span>0.5</span><span>1.0</span></div>
    <div class="small" style="margin-top:4px;display:flex;align-items:center;gap:4px">Tension Histogram <span class="hint" data-hint="X-axis: tension (0 = loose, 1 = rigid). Y-axis: number of tiles in each bucket.">â„¹ï¸</span></div>
    <div id="histTension" style="display:flex;align-items:flex-end;height:40px;gap:2px;width:100%;background:#111a33;border-radius:6px;padding:2px"></div>
    <div class="small" style="display:flex;justify-content:space-between;width:100%;font-size:10px;color:#9eaad1"><span>0</span><span>0.5</span><span>1.0</span></div>
    <div class="small" style="margin-top:4px;display:flex;align-items:center;gap:4px">Heat Histogram <span class="hint" data-hint="X-axis: normalized tile heat (0 = cold, 1 = max). Y-axis: tile count per bin.">â„¹ï¸</span></div>
    <div id="histHeat" style="display:flex;align-items:flex-end;height:40px;gap:2px;width:100%;background:#111a33;border-radius:6px;padding:2px"></div>
    <div class="small" style="display:flex;justify-content:space-between;width:100%;font-size:10px;color:#9eaad1"><span>0</span><span>0.5</span><span>1.0</span></div>
    <div class="row" id="telemetryPanel" style="display:none;margin-top:8px;flex-direction:column;align-items:flex-start;gap:4px">
      <span class="kbd" style="background:#1b2439">Telemetry Inspect</span>
      <div class="row small"><span>Mode</span><span class="kbd" id="tMode">â€”</span></div>
      <div class="row small"><span>Tension <span class="hint" data-hint="Resilience of the strand or crew at this tile. 0 means slack, overstressed fibres like Fire or ClF3; 1 means taut, composed structure like Ice or Calm NPCs. Heat spikes, low oxygen, or agitated neighbours erode it, while cool, oxygen-rich zones let it recover. If tension drops below 0.4 while amplitude climbs, the resident mode is primed to flip into Panic.">â„¹ï¸</span></span><span class="kbd" id="tTension">â€”</span></div>
      <div class="telemetry-bar" aria-label="Tension bar: 0 is relaxed, 1 is maximally taut.">
        <div id="tTensionBar" class="telemetry-bar-fill" style="width:0;background:#ffaf87"></div>
      </div>
      <div class="row small"><span>Amplitude <span class="hint" data-hint="Energy in the local oscillation. 0 is a settled tile (calm crews, ice); values near 1 mean violent motion or combustion. Waves spread by coupling with neighbours, so clustered Fires or panicked agents drive this higher. Sustained amplitude above 0.8 marks hotspots that feed Panic or keep flames roaring until damped by Water or tension rebounds.">â„¹ï¸</span></span><span class="kbd" id="tAmplitude">â€”</span></div>
      <div class="telemetry-bar" aria-label="Amplitude bar: 0 is calm, 1 is peak oscillation.">
        <div id="tAmplitudeBar" class="telemetry-bar-fill" style="width:0;background:#6ec6ff"></div>
      </div>
      <div class="row small"><span>Phase <span class="hint" data-hint="Where this oscillation sits within the 0â€“1 cycle (mapped to 0â€“2Ï€ radians). 0 is aligned with the global baseline, 0.5 is inverted, and quarter offsets show tiles leading or lagging the wave. Phase differences decide how strongly tiles couple: matching phase locks calm zones together, while out-of-phase patches shear energy into nearby modes, shifting colours and fuelling reactions.">â„¹ï¸</span></span><span class="kbd" id="tPhase">â€”</span></div>
      <div class="telemetry-bar" aria-label="Phase bar: 0 aligned with baseline, 1 nearly inverted.">
        <div id="tPhaseBar" class="telemetry-bar-fill" style="width:0;background:#d7f3ff"></div>
      </div>
      <div class="row small"><span>Heat</span><span class="kbd" id="tHeat">â€”</span></div>
      <div class="telemetry-bar">
        <div id="tHeatBar" class="telemetry-bar-fill" style="width:0;background:#ff7a7a"></div>
      </div>
      <div class="small" style="margin-top:4px">History (last 10 frames)</div>
      <div id="historyScrubber" style="display:flex;align-items:center;gap:6px;width:100%">
        <input id="historyIndex" type="range" min="0" max="0" value="0" step="1" style="flex:1">
        <span class="kbd" id="historyLabel">â€”</span>
      </div>
      <div id="telemetryFactory" class="telemetry-factory" aria-live="polite">
        <div class="telemetry-factory-heading small">Factory Telemetry</div>
        <div id="telemetryFactoryList" class="telemetry-factory-list"></div>
      </div>
    </div>
    </div>
  </div>

  <div class="panel legend-panel" id="legendPanel" aria-label="Material legend"></div>
</div>


<script type="module" src="src/bootstrap.js"></script>
</body>
</html>
